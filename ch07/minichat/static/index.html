<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mini Chat — Bootstrap</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f4f6f8; }
        .chat-window { max-width: 900px; margin: 28px auto; }
        #messages { height: 420px; overflow:auto; padding:12px; }
        .msg { margin-bottom: 12px; }
        .msg .bubble { padding:10px 14px; border-radius:14px; display:inline-block; max-width:75%; }
        .msg.me .bubble { background:#0d6efd; color:#fff; border-bottom-right:2px solid rgba(0,0,0,0.06); }
        .msg.other .bubble { background:#fff; color:#222; border:1px solid rgba(0,0,0,0.06); }
        .meta { font-size:0.78rem; color:#6c757d; margin-top:6px; }
        .avatar { width:40px; height:40px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-weight:600; color:#fff; }
        .messages-list { display:flex; flex-direction:column; gap:8px; }
        .msg-row { display:flex; gap:10px; align-items:flex-start; }
        .msg.me .msg-row { flex-direction:row-reverse; }
        .msg.me .avatar { opacity:0.9 }
        .input-area .form-control:focus { box-shadow:none; }
    </style>
</head>
<body>

<div class="chat-window">
    <div class="card shadow-sm">
        <div class="card-header bg-white d-flex align-items-center justify-content-between">
            <div>
                <h5 class="mb-0">Mini Chat</h5>
                <small class="text-muted">Лёгкий чат на WebSocket</small>
            </div>
            <div class="ms-3">
                <label class="form-label mb-0 small">Ваше имя</label>
                <input id="name" class="form-control form-control-sm" value="Guest" style="min-width:140px;" />
            </div>
        </div>

        <div class="card-body d-flex flex-column p-3">
            <div id="messages" class="flex-grow-1 bg-light rounded border messages-list" aria-live="polite"></div>

            <div class="mt-3 input-area">
                <div class="input-group">
                    <input id="text" type="text" class="form-control form-control-lg" placeholder="Введите сообщение..." aria-label="Сообщение">
                    <button id="send" class="btn btn-primary btn-lg">Отправить</button>
                </div>
            </div>
        </div>

        <div class="card-footer text-muted small">Подключение: <span id="wsStatus">—</span></div>
    </div>
</div>

<script>
    const nameInput = document.getElementById('name')
    const messagesDiv = document.getElementById('messages')
    const textInput = document.getElementById('text')
    const sendBtn = document.getElementById('send')
    const wsStatus = document.getElementById('wsStatus')

    // безопасное создание WebSocket URL (поддерживает https)
    const wsProto = location.protocol === 'https:' ? 'wss://' : 'ws://'
    const wsUrl = wsProto + location.host + '/ws'
    const ws = new WebSocket(wsUrl)

    function escapeHtml(s) {
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;')
    }

    function avatarFor(name) {
        const bgColors = ['#6f42c1','#0d6efd','#198754','#fd7e14','#0dcaf0','#d63384']
        const initial = (name || '').trim().charAt(0).toUpperCase() || '?'
        const color = bgColors[(initial.charCodeAt(0) || 63) % bgColors.length]
        return { initial, color }
    }

    function formatTime(iso) {
        try { const d = new Date(iso); return d.toLocaleTimeString(); } catch(e) { return '' }
    }

    function appendMessage(m) {
        const userName = m.user && m.user.name ? m.user.name : 'Guest'
        const mine = (userName === (nameInput.value.trim() || 'Guest'))

        const wrapper = document.createElement('div')
        wrapper.className = 'msg ' + (mine ? 'me' : 'other')

        const row = document.createElement('div')
        row.className = 'msg-row'

        const avatarInfo = avatarFor(userName)
        const avatar = document.createElement('div')
        avatar.className = 'avatar'
        avatar.style.background = avatarInfo.color
        avatar.textContent = avatarInfo.initial

        const bubbleWrap = document.createElement('div')
        const bubble = document.createElement('div')
        bubble.className = 'bubble'
        bubble.innerHTML = `<strong>${escapeHtml(userName)}</strong><div style="margin-top:6px;">${escapeHtml(m.text || '')}</div>`

        const meta = document.createElement('div')
        meta.className = 'meta'
        meta.textContent = formatTime(m.createdAt || new Date())

        bubbleWrap.appendChild(bubble)
        bubbleWrap.appendChild(meta)

        row.appendChild(avatar)
        row.appendChild(bubbleWrap)

        wrapper.appendChild(row)

        messagesDiv.appendChild(wrapper)
        messagesDiv.scrollTop = messagesDiv.scrollHeight
    }

    ws.addEventListener('open', () => { wsStatus.textContent = 'Connected'; console.log('ws open') })
    ws.addEventListener('close', () => { wsStatus.textContent = 'Closed'; console.log('ws closed') })
    ws.addEventListener('error', () => { wsStatus.textContent = 'Error'; console.log('ws error') })

    ws.addEventListener('message', (evt) => {
        try {
            const data = JSON.parse(evt.data)
            if (data.kind === 'initial_messages') {
                (data.messages || []).forEach(appendMessage)
            } else if (Array.isArray(data)) {
                data.forEach(appendMessage)
            } else {
                appendMessage(data)
            }
        } catch (e) {
            console.error('ws msg parse', e)
        }
    })

    sendBtn.addEventListener('click', sendMessage)
    textInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage() })

    function sendMessage() {
        const text = textInput.value.trim()
        const name = nameInput.value.trim() || 'Guest'
        if (!text) return
        const msg = { user: { id: name, name }, text }
        try {
            ws.send(JSON.stringify(msg))
            textInput.value = ''
            // optionally show optimistic UI (uncomment if server doesn't echo)
            // msg.createdAt = new Date().toISOString(); appendMessage(msg)
        } catch (e) {
            console.error('send failed', e)
            alert('Не удалось отправить сообщение — соединение разорвано.')
        }
    }
</script>

<!-- Bootstrap 5 JS (optional for components) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
